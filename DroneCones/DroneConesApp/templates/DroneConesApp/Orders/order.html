{% extends "DroneConesApp/misc/base.html" %}

{% block title %}Order{% endblock %}

{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'DroneConesApp/css/orderpage.css' %}">
<div class="content-container">
    <h1 style="text-align: center; font-size: 30px">Ice Cream</h1>
    <hr style="margin-top: -20px; margin-bottom: 30px">
    <div class="sub-content-container">
        <div class="option-list">
            <ul style="list-style: none; padding: 0; margin: 10px;">
                <li class="selected"><a><img src="{% static 'DroneConesApp/images/Sprites/IceCream/all.png' %}" width="70px" height="70px"><span class="list-label">Ice Cream</span></a></li>
                <li><a><img src="{% static 'DroneConesApp/images/Sprites/Cones/all.png' %}" width="70px" height="70px"><span class="list-label">Cones</span></a></li>
                <li><a><img src="{% static 'DroneConesApp/images/Sprites/Toppings/all.png' %}" width="70px" height="70px"><span class="list-label">Toppings</span></a></li>
            </ul>
        </div>

        <div id="icecreamflavors" style="display: block; margin-left: 50px">
            {% for flavor in ice_cream_flavors %}
            <div id="{{flavor.flavor}}" style="display: inline-block"><a class="pick-icon" data-price="{{flavor.price}}" href="#"><img style="width: 100px; height: auto;" src="{% static 'DroneConesApp/images/Sprites/IceCream/'|add:flavor.flavor|add:'.png' %}"><li>{{flavor.flavor}}</li></a></div>
            {% endfor %}
        </div>

        <div id="coneflavors" style="display: none; margin-left: 50px">
            {% for flavor in cone_flavors %}
            <div style="display: inline-block"><a class="pick-icon" data-price="{{flavor.price}}" href="#"><img style="width: 100px; height: auto;" src="{% static 'DroneConesApp/images/Sprites/Cones/'|add:flavor.flavor|add:'.png' %}"><li>{{flavor.flavor}}</li></a></div>
            {% endfor %}
        </div>

        <div id="toppingflavors" style="display: none; margin-left: 50px">
            {% for flavor in topping_flavors %}
            <div style="display: inline-block"><a class="pick-icon" data-price="{{flavor.price}}" href="#"><img style="width: 100px; height: auto;" src="{% static 'DroneConesApp/images/Sprites/Toppings/'|add:flavor.flavor|add:'.png' %}"><li>{{flavor.flavor}}</li></a></div>
            {% endfor %}
        </div>

    </div>
</div>
<div class="content-container" style="margin-left: 50px; width: 40%; text-align: center">
    <form method="post" action="{% url 'DroneConesApp:order' %}">
        {% csrf_token %}
        <h1 style="text-align: center; font-size: 30px">My Order</h1>
        <hr style="margin-top: -15px; margin-bottom: 30px">
        <h4 style="text-align: center; margin-top: -25px; margin-bottom: 35px; font-size: 10px">*Click an item to remove it from your order*</h4>
        <div class="sub-content-container" id="myOrderContainer" style="width: 100%; display: flex; flex-direction: column; align-items: center; margin-top: -30px; margin-left: 0; padding: 0">
            <div class='order-container' id="order-container">
                <div id="blank-order-item" style="text-align: center; width: 100%">
                    <p>There are currently no items in your cart!</p>
                </div>
            </div>
            <div style="text-align: right; width: 80%">
                <br>
                <a id="add-order-item" class="button" style="display: block; text-align: center;">+ Add Another Item</a>
                <div>
                    <span>Order Amount: $</span>
                    <input type="hidden" id="total-price-input" name="total-price-input">
                    <span id="total-price" style="font-weight: bold; margin-right: 20px">0.00</span>
                </div>
            </div>
        </div>
        <button id="checkout-button" class="button" type="submit" style="width: 80%; margin-top: 10px">
            <img src="{% static 'DroneConesApp/images/checkout.png' %}" height="14px" width="auto"> Checkout
        </button>
    </form>
</div>

<script>
let blank = document.getElementById('blank-order-item');
const addOrderItemButton = document.getElementById('add-order-item')
const optionList = document.querySelector('.option-list ul');
const optionItems = optionList.querySelectorAll('li');
const iceCreamFlavors = document.getElementById('icecreamflavors');
const coneFlavors = document.getElementById('coneflavors');
const toppingFlavors = document.getElementById('toppingflavors');
const flavorDivs = document.querySelectorAll('.pick-icon');
const myOrderContainer = document.getElementById('order-container');
let totalPrice = 0;

addOrderItemButton.addEventListener('click', () => {
    blank.remove();
    deactivateAllOtherDivs();

    const orderItemContainer = document.createElement('div');
    orderItemContainer.classList.add('order-item-container');
    orderItemContainer.setAttribute('data-active', true);

    orderItemContainer.innerHTML = `
        <div class="ice-cream-cone-container">
            <div id="topping-layer">

            </div>
            <div id="ice-cream-layer">

            </div>
            <div id="cone-layer">

            </div>
        </div>

        <div class="item-name-container">
            <ul name="item-names" id="item-names">
            </ul>
        </div>

        <div class="edit-options-container">
            <div class="order-item-actions">
                <span id='edit-button' style="display: none">Edit |</span>
                <span id='remove-button' style="margin-left: 5px;"> Remove</span>
            </div>
            <div class="order-item-quantity">
                <label for="qty" style="font-size: 14px">Qty: </label>
                <input name='qty' type="number" value="1" min="1" max="9" step="1">
            </div>
            <div style="display: flex; flex-direction: row; margin-top: 15px; margin-right: 90px">
                <strong>Subtotal: </strong><span>$</span><span id="subtotal"></span>
            </div>
        </div>
    `;

    //event listeners need to be added every time a new order item is added
    const editButtons = document.querySelectorAll('#edit-button')
    editButtons.forEach((button) => {
        button.style.display = 'block';
    });

    myOrderContainer.appendChild(orderItemContainer);

    reconfigEditButtons();

    const removeButtons = document.querySelectorAll('#remove-button');
    removeButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const parentContainer = button.parentElement.parentElement.parentElement;
            if(parentContainer.getAttribute('data-active') === 'true'){
                parentContainer.remove();
                setLastDivActive()
                updateTotalPrice()
            }
            else{
                parentContainer.remove()
            }
        });
    });
});

function setLastDivActive() {
    const orderItemContainers = document.querySelectorAll('.order-item-container');

    if (orderItemContainers.length > 0) {
        const last = orderItemContainers[orderItemContainers.length - 1];
        last.setAttribute('data-active', 'true');
        last.children[2].children[0].children[0].style.display = 'none';
    }
}


function reconfigEditButtons(){
    const editButtons = document.querySelectorAll('#edit-button');
    editButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const parentContainer = button.parentElement.parentElement.parentElement;
            deactivateAllOtherDivs();
            editButtons.forEach((edit) => {
                edit.style.display = 'block';
            });
            parentContainer.setAttribute('data-active', true);
            button.style.display = 'none';
        });
    });
}


optionItems.forEach((item) => {
    item.addEventListener('click', () => {
        optionItems.forEach((el) => {
            el.classList.remove('selected');
        });
        item.classList.add('selected');
        const selectedOption = item.querySelector('a > span').textContent.toLowerCase();
        iceCreamFlavors.style.display = 'none';
        coneFlavors.style.display = 'none';
        toppingFlavors.style.display = 'none';

        if (selectedOption === 'ice cream') {
            iceCreamFlavors.style.display = 'block';
        } else if (selectedOption === 'cones') {
            coneFlavors.style.display = 'block';
        } else if (selectedOption === 'toppings') {
            toppingFlavors.style.display = 'block';
        }
    });
});


flavorDivs.forEach((flavorDiv) => {
    const flavorImage = flavorDiv.querySelector('img');
    const flavorName = flavorDiv.querySelector('li').textContent;
    const flavorPrice = Number(flavorDiv.getAttribute('data-price'));
    let isButtonVisible = false;

    // Create the "Add to Order" button
    const addButton = document.createElement('button');
    addButton.textContent = 'Add to Order';
    addButton.classList.add('button');
    addButton.style.display = 'none';

    flavorDiv.appendChild(addButton);

    flavorDiv.addEventListener('click', () => {
        if (!isButtonVisible) {
            addButton.style.display = 'block';
            isButtonVisible = true;
        } else {
            addButton.style.display = 'none';
            isButtonVisible = false;
        }
    });

    addButton.addEventListener('click', () => {
        const selectedOption = document.querySelector('.selected').textContent.toLowerCase();
        let activeOrderItem = document.querySelector('.order-item-container[data-active="true"]');
        if(!activeOrderItem){
            addOrderItemButton.click();
            activeOrderItem = document.querySelector('.order-item-container[data-active="true"]');
        }
        const iceCreamLayer = activeOrderItem.children[0].children[1];
        const coneLayer = activeOrderItem.children[0].children[2];
        const toppingLayer = activeOrderItem.children[0].children[0];

        let flavorNameElement = document.createElement('li');
        const activeItemList = activeOrderItem.children[1].children[0];
        flavorNameElement.textContent = flavorName;
        flavorNameElement.setAttribute('data-price', flavorPrice)

        // Add the flavor image to the correct layer
        const flavorImageClone = flavorImage.cloneNode(true);

        if (selectedOption === 'ice cream') {
            flavorImageClone.style.width = '30px';
            flavorNameElement.textContent = "1 Scoop " + flavorName;
            iceCreamLayer.appendChild(flavorImageClone);
        } else if (selectedOption === 'cones') {
            flavorImageClone.style.width = '45px';
            flavorNameElement.textContent = flavorName + " Cone";
            coneLayer.appendChild(flavorImageClone);
        } else if (selectedOption === 'toppings') {
            flavorImageClone.style.width = '30px';
            flavorNameElement.textContent = flavorName;
            toppingLayer.appendChild(flavorImageClone);
        }
        activeItemList.appendChild(flavorNameElement);

        flavorNameElement.addEventListener('click', () => {
            flavorNameElement.remove();

            if (selectedOption === 'ice cream') {
                iceCreamLayer.removeChild(flavorImageClone);
            } else if (selectedOption === 'cones') {
                coneLayer.removeChild(flavorImageClone);
            } else if (selectedOption === 'toppings') {
                toppingLayer.removeChild(flavorImageClone);
            }

            updateTotalPrice()
            const totalElement = document.getElementById('total-price');
            console.log(totalElement.textContent)
            if(totalElement.textContent === "0.00"){
                activeOrderItem.remove()
            }
        });

        blank.remove();
        updateTotalPrice();
    });
});

function updateTotalPrice() {
    const orderContainers = document.querySelectorAll('.order-item-container');
    let total = 0;
    orderContainers.forEach((orderContainer) => {
        const containerItems = orderContainer.querySelectorAll('#item-names > li');
        let subtotal = 0;

        containerItems.forEach((entry) => {
            const price = Number(entry.getAttribute('data-price')) / 100;
            const quantity = parseInt(orderContainer.children[2].querySelector('input[name="qty"]').value, 10);
            subtotal += price * quantity;
        });

        total += subtotal

        const subtotalElement = orderContainer.querySelector('#subtotal');
        subtotalElement.textContent = subtotal.toFixed(2);
    });

    const totalElement = document.getElementById('total-price')
    totalElement.textContent = total.toFixed(2);
}

function deactivateAllOtherDivs(){
    const allOrderItemContainers = document.querySelectorAll('.order-item-container');
    allOrderItemContainers.forEach((entry) => {
        entry.setAttribute('data-active', false)
    });
}

</script>




{% endblock %}